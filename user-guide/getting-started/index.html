
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Framework for writing and maintaining (postgres)SQL queries and (pgTAP) tests">
      
      
      
      
        <link rel="prev" href="../install/">
      
      
        <link rel="next" href="../manifest/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.23">
    
    
      
        <title>Getting started - tapestry</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#getting-started" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="tapestry" class="md-header__button md-logo" aria-label="tapestry" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            tapestry
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Getting started
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/naiquevin/tapestry" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    naiquevin/tapestry
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  User Guide

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../rationale/" class="md-tabs__link">
        
  
    
  
  Rationale

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="tapestry" class="md-nav__button md-logo" aria-label="tapestry" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    tapestry
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/naiquevin/tapestry" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    naiquevin/tapestry
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Getting started
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Getting started
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#sample-database" class="md-nav__link">
    <span class="md-ellipsis">
      Sample database
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#init" class="md-nav__link">
    <span class="md-ellipsis">
      Init
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-a-query_template-to-generate-queries" class="md-nav__link">
    <span class="md-ellipsis">
      Adding a query_template to generate queries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rendering" class="md-nav__link">
    <span class="md-ellipsis">
      Rendering
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-a-test_template" class="md-nav__link">
    <span class="md-ellipsis">
      Adding a test_template
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Run tests
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thats-all" class="md-nav__link">
    <span class="md-ellipsis">
      That's all!
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../manifest/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Manifest
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../query-templates/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Query templates
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../test-templates/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Test templates
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../layouts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Layouts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../query-tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Query Tags
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../naming-conventions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Naming conventions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../commands/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pg-format/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pg_format
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rationale/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rationale
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#sample-database" class="md-nav__link">
    <span class="md-ellipsis">
      Sample database
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#init" class="md-nav__link">
    <span class="md-ellipsis">
      Init
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-a-query_template-to-generate-queries" class="md-nav__link">
    <span class="md-ellipsis">
      Adding a query_template to generate queries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rendering" class="md-nav__link">
    <span class="md-ellipsis">
      Rendering
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-a-test_template" class="md-nav__link">
    <span class="md-ellipsis">
      Adding a test_template
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Run tests
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thats-all" class="md-nav__link">
    <span class="md-ellipsis">
      That's all!
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="getting-started">Getting started</h1>
<p>This tutorial is to help you get started with tapestry. It's assumed
that the following software is installed on your system:</p>
<ul>
<li><a href="../install/"><code>tapestry</code></a></li>
<li><a href="../install/#additional-dependencies"><code>pg_format</code></a></li>
<li>a working installation of PostgreSQL (<a href="https://www.postgresql.org/download/">official
  docs</a>)</li>
<li><a href="http://127.0.0.1:8000/user-guide/install/#dependencies-for-running-tests"><code>pgTAP</code> and <code>pg_prove</code></a></li>
</ul>
<h2 id="sample-database">Sample database</h2>
<p>For this tutorial, we'll use the
<a href="https://github.com/lerocha/chinook-database">chinook</a> sample
database. Download and import it as follows,</p>
<div class="highlight"><pre><span></span><code>wget<span class="w"> </span>-P<span class="w"> </span>/tmp/<span class="w"> </span>https://github.com/lerocha/chinook-database/releases/download/v1.4.5/Chinook_PostgreSql_SerialPKs.sql
createdb<span class="w"> </span>chinook
psql<span class="w"> </span>-d<span class="w"> </span>chinook<span class="w"> </span>-f<span class="w"> </span>/tmp/Chinook_PostgreSql_SerialPKs.sql
</code></pre></div>
<h2 id="init">Init</h2>
<p>We'll start by running the <a href="../commands/#init"><code>tapestry init</code></a>
command, which will create the directory structure and also write a
bare minimum <a href="../manifest/">manifest</a> file for us. In a real project,
you'd run this command from within the main project directory, so that
the files can be committed to the same repo. But for this tutorial,
you can run it from any suitable location e.g. the home dir <code>~/</code></p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/
tapestry<span class="w"> </span>init<span class="w"> </span>chinook
</code></pre></div>
<p>This will create a directory named <code>chinook</code> with following structure,</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>chinook
$<span class="w"> </span>tree<span class="w"> </span>-a<span class="w"> </span>--charset<span class="o">=</span>ascii<span class="w"> </span>.
.
<span class="p">|</span>--<span class="w"> </span>.pg_format
<span class="p">|</span><span class="w">   </span><span class="sb">`</span>--<span class="w"> </span>config
<span class="p">|</span>--<span class="w"> </span>tapestry.toml
<span class="sb">`</span>--<span class="w"> </span>templates
<span class="w">    </span><span class="p">|</span>--<span class="w"> </span>queries
<span class="w">    </span><span class="sb">`</span>--<span class="w"> </span>tests
</code></pre></div>
<p>Let's look at the <code>tapestry.toml</code> <a href="../manifest/">manifest</a> file that
has been created (I've stripped out some comments for conciseness)</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>tapestry.toml
<span class="nv">placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;posargs&quot;</span>

<span class="nv">query_templates_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;templates/queries&quot;</span>
<span class="nv">test_templates_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;templates/tests&quot;</span>

<span class="nv">queries_output_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;output/queries&quot;</span>
<span class="nv">tests_output_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;output/tests&quot;</span>

<span class="o">[</span>formatter.pgFormatter<span class="o">]</span>
<span class="nv">exec_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;pg_format&quot;</span>
<span class="nv">conf_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./.pg_format/config&quot;</span>

<span class="o">[</span>name_tagger<span class="o">]</span>
<span class="nv">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kebab-case&quot;</span>

<span class="c1"># [[query_templates]]</span>

<span class="c1"># [[queries]]</span>

<span class="c1"># [[test_templates]]</span>
</code></pre></div>
<p><a href="../manifest/#placeholder"><code>placeholder</code></a> defines the style of
generated queries. Default is <code>posargs</code> (positional arguments) which
will generate queries with <code>$1</code>, <code>$2</code> etc as the placeholders. These
are suitable for defining prepared statements.</p>
<p>Then there are four toml keys for defining directories,</p>
<ol>
<li>
<p><code>query_templates_dir</code> is where the query templates will be located</p>
</li>
<li>
<p><code>test_templates_dir</code> is where the test templates will be located</p>
</li>
<li>
<p><code>queries_output_dir</code> is where the SQL files for queries will be
   generated</p>
</li>
<li>
<p><code>tests_output_dir</code> is where the SQL files for pgTAP tests will be
   generated.</p>
</li>
</ol>
<p>All directory paths are relative to the manifest file.</p>
<p>You may have noticed that the <code>init</code> command created only the
templates dirs. <code>output</code> dirs will be created when <code>tapestry render</code>
is called for the first time.</p>
<p>The <code>init</code> command has also created a <code>pg_format</code> config file for
us. This is because it found the <code>pg_format</code> executable on
<code>PATH</code>. Refer to the <a href="../pg-format/"><code>pg_format</code></a> section for more
details.</p>
<p>Finally, <a href="../manifest/#name_tagger"><code>name_tagger</code></a> has been configured
with <code>kebab-case</code> as the <a href="../manifest/#style"><code>style</code></a>.</p>
<h2 id="adding-a-query_template-to-generate-queries">Adding a query_template to generate queries</h2>
<p>Now we'll define a query template. But before that, you might want to
get yourself familiar with the <a href="https://github.com/lerocha/chinook-database?tab=readme-ov-file#data-model">chinook database's
schema</a>.</p>
<p>Suppose we have an imaginary application built on top of the chinook
database in which the following queries need to be run,</p>
<ol>
<li>
<p>list all artists with their longest songs</p>
</li>
<li>
<p>list top 10 artists having longest songs</p>
</li>
<li>
<p>list top 5 artists having longest songs, and of a specific genre</p>
</li>
</ol>
<p>As you can see, we'd need different queries for each of the 3
requirements, but all have a common logic of finding longest songs per
artist. Using Jinja syntax, we can write a query template that covers
all 3 cases as follows,</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">artist_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="s1">&#39;1 ms&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">duration</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">track</span><span class="w"> </span><span class="n">t</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">album</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">album_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">artist</span><span class="w"> </span><span class="n">ar</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">artist_id</span><span class="p">)</span>
<span class="err">{</span><span class="o">%</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cond__genre</span><span class="w"> </span><span class="o">%</span><span class="err">}</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">genre</span><span class="w"> </span><span class="k">g</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">genre_id</span><span class="p">)</span>
<span class="w">  </span><span class="k">WHERE</span>
<span class="w">  </span><span class="k">g</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{{</span><span class="w"> </span><span class="n">placeholder</span><span class="p">(</span><span class="s1">&#39;genre&#39;</span><span class="p">)</span><span class="w"> </span><span class="err">}}</span>
<span class="err">{</span><span class="o">%</span><span class="w"> </span><span class="n">endif</span><span class="w"> </span><span class="o">%</span><span class="err">}</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">artist_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="c1">-- Descending order because we want the top artists</span>
<span class="w">    </span><span class="n">duration</span><span class="w"> </span><span class="k">DESC</span>
<span class="err">{</span><span class="o">%</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cond__limit</span><span class="w"> </span><span class="o">%</span><span class="err">}</span>
<span class="w">  </span><span class="k">LIMIT</span><span class="w"> </span><span class="err">{{</span><span class="w"> </span><span class="n">placeholder</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">)</span><span class="w"> </span><span class="err">}}</span>
<span class="err">{</span><span class="o">%</span><span class="w"> </span><span class="n">endif</span><span class="w"> </span><span class="o">%</span><span class="err">}</span>
<span class="p">;</span>
</code></pre></div>
<p>We've used some custom Jinja variables for selectively including parts
of SQL in the query. These need to be prefixed with <code>cond__</code> and have
to be defined in the manifest file (we'll come to that a bit later).</p>
<p>We have also used the custom Jinja function <code>placeholder</code> which takes
one arg and expands to a placeholder in the actual query. This will be
clear once we render the queries.</p>
<p>Let's save the above query template to the file
<code>templates/queries/artists_long_songs.sql.j2</code>.</p>
<p>And now we'll proceed to defining the query_template and the queries
that it can generate in the manifest file. Edit the <code>tapestry.toml</code>
file by appending the following lines to it.</p>
<div class="highlight"><pre><span></span><code><span class="k">[[query_templates]]</span>
<span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;artists_long_songs.sql.j2&quot;</span>
<span class="n">all_conds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;genre&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;limit&quot;</span><span class="w"> </span><span class="p">]</span>
</code></pre></div>
<p>To define a <code>query_template</code> we need to specify 2 keys:</p>
<ol>
<li>
<p><code>path</code> i.e. where the template file is located relative to the
   <code>query_templates_dir</code> defined earlier in the manifest. <code>path</code>
   itself is considered as the unique identifier for the query
   template.</p>
</li>
<li>
<p><code>all_conds</code> is a set of values that will be converted to <code>cond__</code>
   Jinja variables. In this case it means there are two <code>cond__</code> Jinja
   templates supported by the template - <code>cond__genre</code> and
   <code>cond__limit</code>. Note that they are defined in the manifest without
   the <code>cond__</code> suffix.</p>
</li>
</ol>
<p>We can now define three different queries that map to the same
query_template</p>
<div class="highlight"><pre><span></span><code><span class="k">[[queries]]</span>
<span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;artists_long_songs&quot;</span>
<span class="n">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;artists_long_songs.sql.j2&quot;</span>
<span class="n">conds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="k">[[queries]]</span>
<span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;artists_long_songs*limit&quot;</span>
<span class="n">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;artists_long_songs.sql.j2&quot;</span>
<span class="n">conds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;limit&quot;</span><span class="w"> </span><span class="p">]</span>

<span class="k">[[queries]]</span>
<span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;artists_long_songs@genre*limit&quot;</span>
<span class="n">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;artists_long_songs.sql.j2&quot;</span>
<span class="n">conds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;genre&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;limit&quot;</span><span class="w"> </span><span class="p">]</span>
</code></pre></div>
<p>To define a query, we need to specify 3 keys,</p>
<ol>
<li>
<p><code>id</code> is an identifier for the query. Notice that we're following a
   naming convention by using special chars <code>@</code> and <code>*</code>. Read more
   about <a href="../naming-conventions/">Query naming conventions</a>.</p>
</li>
<li>
<p><code>template</code> is reference to the query template that we defined
   earlier.</p>
</li>
<li>
<p><code>conds</code> is a subset of the <code>all_conds</code> key that's defined for the
   linked query template. In the context of this query, only the
   corresponding <code>cond__</code> Jinja variables will have the value <code>true</code>,
   and the rest of them will be <code>false</code>.</p>
</li>
</ol>
<p>We've defined three queries that use the same template. In the first
query, both the <code>conds</code> that the template supports i.e. "genre" and
"limit" are false. In the second query, "limit" is true but "genre" is
false. In the third query, both "genre" and "limit" are true. Queries
will be rendered based on these variables and the <code>{% if cond__.. %}</code>
expressions in the template.</p>
<p>Don't worry if all this doesn't make much sense at this point. Things
will be clear when we'll run <code>tapestry render</code> shortly.</p>
<h2 id="rendering">Rendering</h2>
<p>Now let's run the <code>tapestry render</code> command.</p>
<div class="highlight"><pre><span></span><code>tapestry<span class="w"> </span>render
</code></pre></div>
<p>And you'll notice some files created in our directory.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>tree<span class="w"> </span>-a<span class="w"> </span>--charset<span class="o">=</span>ascii<span class="w"> </span>.
.
<span class="p">|</span>--<span class="w"> </span>.pg_format
<span class="p">|</span><span class="w">   </span><span class="sb">`</span>--<span class="w"> </span>config
<span class="p">|</span>--<span class="w"> </span>output
<span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>queries
<span class="p">|</span><span class="w">   </span><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>artists_long_songs-genre-limit.sql
<span class="p">|</span><span class="w">   </span><span class="p">|</span><span class="w">   </span><span class="p">|</span>--<span class="w"> </span>artists_long_songs-limit.sql
<span class="p">|</span><span class="w">   </span><span class="p">|</span><span class="w">   </span><span class="sb">`</span>--<span class="w"> </span>artists_long_songs.sql
<span class="p">|</span><span class="w">   </span><span class="sb">`</span>--<span class="w"> </span>tests
<span class="p">|</span>--<span class="w"> </span>tapestry.toml
<span class="sb">`</span>--<span class="w"> </span>templates
<span class="w">    </span><span class="p">|</span>--<span class="w"> </span>queries
<span class="w">    </span><span class="p">|</span><span class="w">   </span><span class="sb">`</span>--<span class="w"> </span>artists_long_songs.sql.j2
<span class="w">    </span><span class="sb">`</span>--<span class="w"> </span>tests
</code></pre></div>
<p>Here is what the generated output files look like:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">artists_long_songs.sql</label><label for="__tabbed_1_2">artists_long_songs-limit.sql</label><label for="__tabbed_1_3">artists_long_songs-genre-limit.sql</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1">-- name: artists-long-songs</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">artist_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="s1">&#39;1 ms&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">duration</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">track</span><span class="w"> </span><span class="n">t</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">album</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">album_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">artist</span><span class="w"> </span><span class="n">ar</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">artist_id</span><span class="p">)</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">artist_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="c1">-- Descending order because we want the top artists</span>
<span class="w">    </span><span class="n">duration</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1">-- name: artists-long-songs-limit</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">artist_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="s1">&#39;1 ms&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">duration</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">track</span><span class="w"> </span><span class="n">t</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">album</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">album_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">artist</span><span class="w"> </span><span class="n">ar</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">artist_id</span><span class="p">)</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">artist_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="c1">-- Descending order because we want the top artists</span>
<span class="w">    </span><span class="n">duration</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="p">;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1">-- name: artists-long-songs-genre-limit</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">artist_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="s1">&#39;1 ms&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">duration</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">track</span><span class="w"> </span><span class="n">t</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">album</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">album_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">artist</span><span class="w"> </span><span class="n">ar</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">artist_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">genre</span><span class="w"> </span><span class="k">g</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">genre_id</span><span class="p">)</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="k">g</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">artist_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="c1">-- Descending order because we want the top artists</span>
<span class="w">    </span><span class="n">duration</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="p">;</span>
</code></pre></div>
</div>
</div>
</div>
<p>The SQL comments before the SQL with name of the query are generated
by <code>name_tagger</code> added to the manifest. Learn more about <a href="../query-tags/#name-tagging-queries">Name
tagging</a>.</p>
<p>Also notice that the output SQL is formatted by <code>pg_format</code>.</p>
<h2 id="adding-a-test_template">Adding a test_template</h2>
<p>Now that we've defined and rendered queries, let's add
<code>test_template</code>. Again there are two changes required - an entry in
the manifest file and the Jinja template itself.</p>
<p>Add the following lines to the manifest file.</p>
<div class="highlight"><pre><span></span><code><span class="k">[[test_templates]]</span>
<span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;artists_long_songs@genre*limit&quot;</span>
<span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;artists_long_songs-genre-limit_test.sql.j2&quot;</span>
</code></pre></div>
<p>Here we're referencing the query <code>artists_long_songs@genre*limit</code>
hence this test is meant for that query. The <code>path</code> key points to a
test template file that we need to create. So let's create the file
<code>templates/tests/artists_long_songs-genre-limit_test.sql.j2</code> with the
following contents:</p>
<div class="highlight"><pre><span></span><code><span class="k">PREPARE</span><span class="w"> </span><span class="n">artists_long_songs</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span>
<span class="err">{{</span><span class="w"> </span><span class="n">prepared_statement</span><span class="w"> </span><span class="err">}}</span><span class="p">;</span>

<span class="k">BEGIN</span><span class="p">;</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">plan</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">-- start(noformat)</span>
<span class="c1">-- Run the tests.</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">results_eq</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;EXECUTE artists_long_songs(&#39;&#39;Rock&#39;&#39;, 10)&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="err">$$</span><span class="k">VALUES</span>
<span class="w">        </span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Led Zeppelin&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:26:52.329&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Deep Purple&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:19:56.094&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">59</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Santana&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:17:50.027&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">136</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Terry Bozzio, Tony Levin &amp; Steve Stevens&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:14:40.64&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">140</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;The Doors&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:11:41.831&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Iron Maiden&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:11:18.008&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Frank Zappa &amp; Captain Beefheart&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:11:17.694&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Rush&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:11:07.428&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">76</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Creedence Clearwater Revival&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:11:04.894&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">92</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Jamiroquai&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:10:16.829&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">)</span>
<span class="w">    </span><span class="err">$$</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;Verify return value&#39;</span>
<span class="p">);</span>
<span class="c1">-- Finish the tests and clean up.</span>
<span class="c1">-- end(noformat)</span>

<span class="k">SELECT</span>
<span class="w">    </span><span class="o">*</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">finish</span><span class="w"> </span><span class="p">();</span>
<span class="k">ROLLBACK</span><span class="p">;</span>
</code></pre></div>
<p>The test syntax is SQL only but with some additional functions
installed by <code>pgTAP</code>. If you are not familiar with <code>pgTAP</code> you can go
through it's documentation. But for this tutorial, it's sufficient to
understand that the <code>{{ prepared_statement }}</code> Jinja variable is made
available to this template, and when it's rendered it will expand to
the actual query.</p>
<p>Let's run the <code>render</code> command again.</p>
<div class="highlight"><pre><span></span><code>tapestry<span class="w"> </span>render
</code></pre></div>
<p>And now you should see the pgTAP test file created at
<code>output/tests/artists_long_songs-genre-limit_test.sql</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here the file
stem of the test template <code>path</code> itself was used as the output file
name. But it's also possible to explicitly specify it in the manifest
file (see <a href="../manifest/#output_1">output</a> in <code>test_templates</code> docs).</p>
</div>
<p>This is how the rendered test file looks like,</p>
<div class="highlight"><pre><span></span><code><span class="k">PREPARE</span><span class="w"> </span><span class="n">artists_long_songs</span><span class="w"> </span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">artist_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="s1">&#39;1 ms&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">duration</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">track</span><span class="w"> </span><span class="n">t</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">album</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">album_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">artist</span><span class="w"> </span><span class="n">ar</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">artist_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">genre</span><span class="w"> </span><span class="k">g</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">genre_id</span><span class="p">)</span>
<span class="k">WHERE</span>
<span class="w">    </span><span class="k">g</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="n">ar</span><span class="p">.</span><span class="n">artist_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="w">    </span><span class="c1">-- Descending order because we want the top artists</span>
<span class="w">    </span><span class="n">duration</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="p">;</span>

<span class="k">BEGIN</span><span class="p">;</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">plan</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="c1">-- start(noformat)</span>
<span class="c1">-- Run the tests.</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">results_eq</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;EXECUTE artists_long_songs(&#39;&#39;Rock&#39;&#39;, 10)&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="err">$$</span><span class="k">VALUES</span>
<span class="w">        </span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Led Zeppelin&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:26:52.329&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Deep Purple&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:19:56.094&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">59</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Santana&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:17:50.027&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">136</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Terry Bozzio, Tony Levin &amp; Steve Stevens&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:14:40.64&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">140</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;The Doors&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:11:41.831&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Iron Maiden&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:11:18.008&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Frank Zappa &amp; Captain Beefheart&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:11:17.694&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Rush&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:11:07.428&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">76</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Creedence Clearwater Revival&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:11:04.894&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="mi">92</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Jamiroquai&#39;</span><span class="p">::</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;00:10:16.829&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">)</span>
<span class="w">    </span><span class="err">$$</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;Verify return value&#39;</span>
<span class="p">);</span>
<span class="c1">-- Finish the tests and clean up.</span>
<span class="c1">-- end(noformat)</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="o">*</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">finish</span><span class="w"> </span><span class="p">();</span>
<span class="k">ROLLBACK</span><span class="p">;</span>
</code></pre></div>
<h2 id="run-tests">Run tests</h2>
<p>Assuming that all the above mentioned prerequisites are installed, you
can run the tests as follows,</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>pg_prove<span class="w"> </span>-d<span class="w"> </span>chinook<span class="w"> </span>--verbose<span class="w"> </span>output/tests/*.sql
</code></pre></div>
<p>If all goes well, the tests should pass and you should see output similar to,</p>
<div class="highlight"><pre><span></span><code><span class="m">1</span>..1
ok<span class="w"> </span><span class="m">1</span><span class="w"> </span>-<span class="w"> </span>Verify<span class="w"> </span><span class="k">return</span><span class="w"> </span>value
ok
All<span class="w"> </span>tests<span class="w"> </span>successful.
<span class="nv">Files</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">Tests</span><span class="o">=</span><span class="m">1</span>,<span class="w">  </span><span class="m">0</span><span class="w"> </span>wallclock<span class="w"> </span>secs<span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>.03<span class="w"> </span>usr<span class="w">  </span><span class="m">0</span>.01<span class="w"> </span>sys<span class="w"> </span>+<span class="w">  </span><span class="m">0</span>.01<span class="w"> </span>cusr<span class="w">  </span><span class="m">0</span>.00<span class="w"> </span><span class="nv">csys</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="m">0</span>.05<span class="w"> </span>CPU<span class="o">)</span>
Result:<span class="w"> </span>PASS
</code></pre></div>
<h2 id="thats-all">That's all!</h2>
<p>If you've reached this far, you should now have a basic understanding
of what <code>tapestry</code> is and how to use it. Next, it'd be a good idea to
understand the <a href="../manifest/">manifest file</a> in more detail.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The chinook example discussed in this tutorial can also be found in
the github repo under the <code>examples/chinook</code> directory (there are a
few more tests included for reference).</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 Vineet Naik
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ebd0bdb7.min.js"></script>
      
    
  </body>
</html>